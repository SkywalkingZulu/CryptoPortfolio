<!DOCTYPE html>
<html>
	<head>
		<title>Crypto Portfolio</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css">
		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<!-- Latest compiled JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
	</head>
	<body>
		<div class="container">
			<h1>Crypto Portfolio</h1>

			<div class="row">
			  <div class="col-sm-12">
				 <div class="table-responsive">
				  <table id="crypto" class="table table-hover">
				  <thead>
					<tr>
					  <th>Coin</th>
					  <th>Tokens Owned</th>
					  <th>USD Per Token</hd>
					  <th>USD Value</th>
					  <th>BTC Value</th>
					</tr>
				  </thead>
				  <tbody>
						<!-- Rows to be added dynamically -->
				  </tbody>
				  <tfoot>
					<tr id="Totals_Row">
					  <td>Total</td>
					  <td></td>
					  <td></td>
					  <td></td>
					  <td></td>
					</tr>
				  </tfoot>
				</table>
				</div>
			  </div>
			</div>
		</div>

		<!-- Loads Tokens, Example File:
		var coinJSON = '{"assets":[' +
		'{"symbol":"ETH","numberOfTokens":"1" },' +
		'{"symbol":"LTC","numberOfTokens":"1" }]}';
		-->
		<script src="Portfolio.json"></script>
		<!-- https://min-api.cryptocompare.com/data/price?fsym=ETH&tsyms=USD,BTC -->
		<script>
			var coinsCompleted = 0;
			var totalUSD = 0;
			var totalBTC = 0;

			function BuildCoinValueTable(coin, numberOfCoins, tableBodyHtml){
				var url = "https://min-api.cryptocompare.com/data/price?fsym=" + coin.symbol + "&tsyms=USD,BTC";

				$.ajax({
					type: 'GET',
					url: url,
					async: true,
					dataType: 'json',
					success: function (data) {
						var coinId = "#" + coin.symbol + "_Row";
						var usdValue = data.USD *  coin.numberOfTokens;
						var btcValue = data.BTC * coin.numberOfTokens;
						totalUSD = totalUSD + usdValue;
						totalBTC = totalBTC + btcValue;
						tableBodyHtml.push("<tr><td>" + coin.symbol + "</td><td>" + coin.numberOfTokens + "</td><td>" + (data.USD).toFixed(data.USD < '0.01' ? 6 : 2) + "</td><td>" + usdValue.toFixed(2) + "</td><td>" + btcValue + "</td></tr>");
						coinsCompleted = coinsCompleted + 1;

						if(coinsCompleted == numberOfCoins){
							//Insert Body and Totals
							$("#crypto tbody").append(tableBodyHtml);
							$("#Totals_Row td:nth-child(4)").html("$" + totalUSD.toFixed(2));
							$("#Totals_Row td:nth-child(5)").html(totalBTC);
							$('#crypto').DataTable({ "pagingType": "full_numbers" });
						}
					}
				});
			}

		  $(document).ready(function(){
				var coins = JSON.parse(coinJSON);
				
				for (var key in coins) {
					var tableBodyHtml = [];
					for (i = 0; i < coins[key].length; i++) {
						var coin = coins[key][i]
						BuildCoinValueTable(coin, coins[key].length, tableBodyHtml);
							}
					}
		  });
		</script>
	</body>
</html>
