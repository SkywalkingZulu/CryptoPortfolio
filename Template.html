<!DOCTYPE html>
<html>
	<head>
		<title>My Portfolio</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="shortcut icon" href="favicon-bitcoin.ico" type="image/x-icon">
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css">
		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<!-- Latest compiled JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>

		<style>
			tfoot { font-weight: bold;}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<a class="navbar-brand" href="#">Crypto Portfolio</a>
				</div>
				<div class="collapse navbar-collapse">
					<ul class="nav navbar-nav navbar-right">
						<li class="active"><a href="#">My Portfolio</a></li>
						<li><a href="Trends.html">Trends</a></li>
					</ul>
				</div><!-- /.navbar-collapse -->
			</div><!-- /.container-fluid -->
		</nav>

		<div class="container">
			<h1>Crypto Portfolio</h1>

			<div class="row">
			  	<div class="col-sm-12">
					<div class="table-responsive">
				  	<table id="crypto" class="table table-hover">
				  		<thead>
								<tr>
									<th>Coin</th>
									<th style="text-align: right">Tokens Owned</th>
									<th style="text-align: right">USD Per Token</th>
									<th style="text-align: right">USD Value</th>
									<th style="text-align: right">BTC Value</th>
									<th style="text-align: right">% of Total Value</th>
								</tr>
							</thead>
				  		<tbody>
								<!-- Rows to be added dynamically -->
				  		</tbody>
							<tfoot>
								<tr id="Totals_Row">
									<td>Total</td>
									<td></td>
									<td></td>
									<td style="text-align: right"></td>
									<td style="text-align: right"></td>
									<td></td>
								</tr>
								<tr id="Investments_Row">
									<td>Investments</td>
									<td></td>
									<td style="text-align: right">Total</td>
									<td style="text-align: right"></td>
									<td style="text-align: right">ROI</td>
									<td style="text-align: right"></td>
								</tr>
							</tfoot>
						</table>
					</div>
			  	</div>
			</div>
		</div>

		<!-- Loads Tokens, Example File:
		var coinJSON = '{"assets":[' +
		'{"symbol":"ETH","numberOfTokens":"1" },' +
		'{"symbol":"LTC","numberOfTokens":"1" }]}';
		-->
		<script src="Portfolio.json"></script>
		<script>
			/*
					Builds the URL for retrieving the basic pricing informtion for the coins in your portfolio
			    Example URL: https://min-api.cryptocompare.com/data/pricemulti?fsyms=ETH,DASH&tsyms=BTC,USD
			*/
			function BuildPricingInformationURL(coins){
				var tokenSybmols = '';
				var tableBodyHtml = [];

				// Iterates over your coins to build a list of coin symbols to be used in the api call
				for (i = 0; i < coins["assets"].length; i++) {
					var coin = coins["assets"][i]
					tokenSybmols += i == 0 ? coin.symbol : ',' + coin.symbol;
						}

				return 'https://min-api.cryptocompare.com/data/pricemulti?fsyms=' + tokenSybmols + '&tsyms=BTC,USD';
			}

			/*
					Build the baic pricing table using the pricing information return by the api + the coins in your portfolio
			*/
			function BuildCoinValueTable(coins, coinsPricing){
				var totalUSD = 0;
				var totalBTC = 0;
				var tableBodyHtml = [];

				// Iterates over you coins, calculating the total values of your portfolio in btc and usd.
				// This is done separately in order to allow for percent of value to be calculated when building the html table.
				for (i = 0; i < coins["assets"].length; i++) {
					var coin = coins["assets"][i];
					var usdValue = coinsPricing[coin.symbol].USD *  coin.numberOfTokens;
					var btcValue = coinsPricing[coin.symbol].BTC * coin.numberOfTokens;

					totalUSD += usdValue;
					totalBTC += btcValue;
				}


				// Iterates over your coins, combining your personal coin information with the returned pricing information
				// to create the basic pricing information table
				for (i = 0; i < coins["assets"].length; i++) {
					var coin = coins["assets"][i]
					var coinId = "#" + coin.symbol + "_Row";
					var usdValue = coinsPricing[coin.symbol].USD *  coin.numberOfTokens;
					var btcValue = coinsPricing[coin.symbol].BTC * coin.numberOfTokens;
					var percentOfTotalValue =  usdValue/totalUSD*100;
					tableBodyHtml.push("<tr><td>" + coin.symbol + "</td><td style='text-align: right'>" + coin.numberOfTokens + "</td><td style='text-align: right'>" + "$" + (coinsPricing[coin.symbol].USD).toFixed(coinsPricing[coin.symbol].USD < '0.01' ? 6 : 2) + "</td><td style='text-align: right'>" + "$" + usdValue.toFixed(2) +
					"</td><td style='text-align: right'>" + btcValue + "</td>" + "<td style='text-align: right'>" + percentOfTotalValue.toFixed(2) + "%" + "</td></tr>");
				}

				// Optional ROI calculation.
				// Set totalInvestment variable in Portfolio.json (eg. var totalInvestment = 100;)
				var roi = typeof totalInvestment !== 'undefined' ? (((totalUSD / totalInvestment) - 1) * 100) : 'empty';

				//Insert Body and Totals
				$("#crypto tbody").append(tableBodyHtml);
				$("#Totals_Row td:nth-child(4)").html("$" + totalUSD.toFixed(2));
				$("#Totals_Row td:nth-child(5)").html(totalBTC);
				if (roi === 'empty'){
					$("#Investments_Row").hide();
				}else{
					$("#Investments_Row td:nth-child(4)").html("$" + totalInvestment.toFixed(2));
					$("#Investments_Row td:nth-child(6)").html(roi.toFixed(2) + '%');
				}
				$('#crypto').DataTable({
					"pagingType": "full_numbers",
					// Default is 10 rows per page. Add a pageLength variable to Portfolio.json to
					// set a custom page length. (Eg. var pageLength = 25;)
					"pageLength": typeof pageLength !== 'undefined' ? pageLength : 10
				});
			}

		  	$(document).ready(function(){
				var coins = JSON.parse(coinJSON);
				var url = BuildPricingInformationURL(coins);
				$.get(url, function(data, status){
					BuildCoinValueTable(coins, data);
				});
		  	});
		</script>
	</body>
</html>
